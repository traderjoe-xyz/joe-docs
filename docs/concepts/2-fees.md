---
sidebar_position: 2
sidebar_label: Fees
---

# Fees

## Introduction

In this section we discuss fees. Fees on the Liquidity Book differs from the usual fixed rate fee from Joe V1, as here they depends on the volatility.

The swap fee is paid to liquidity providers for the trading activity that occurs. The total swap fee ($f_s$) will have two components: a **base fee** ($f_b$) and a **variable fee** ($f_v$), which is a function of instantaneous price volatility. The fee rate will be applied to the swap amount in each liquidity bin and distributed proportionally to the liquidity providers in that bin following a distribution to the protocol. Fees will be held separate from liquidity and claimable by liquidity providers.

## Base Fee

The base fee is similar to the Joe V1 0.3% fee. The exact percentage is set by the protocol owner using the **base factor** ($B$) and the **bin step** ($s$):

$$
f_b = B \cdot s
$$

### Variable Fee

The variable fee on the other hand depends on the volatility of the market. It will be affected by the frequency of the swaps, but doing large swaps accross many bins (on large price movements) will also increase it. The variable fee is calculated for every bin crossed during a swap individually and then summed up. The variable fee for a specific bin ($f_v(k)$) will be calculated using the **variable fee control** ($A$), bin step ($s$) and the **volatility accumulator** ($v_a(k)$):

$$
f_v(k) = A(v_a(k) \cdot s) ^ 2
$$

### Volatility Accumulator

The **volatility accumulator** ($v_a(k)$) is the witness of the current volatility of the pair. This value will be kept in memory between each calculation. It will be calculated during a swap and will depend on two factors: the **volatility reference** ($v_r$) from the previous swaps, and the **introduced volatility**.

At the beginning of every swap, the **volatility accumulator** of the previous swap will become the **volatility reference** for the current one. It is adjusted depending on how much time passed since the last swap, following this formula:
$$
 v_r = \begin{cases}
          v_a, & t < t_f \\
          R * v_a, & t_f <= t < t_d \\
          0 , & t_d <= t
        \end{cases}
$$
If we passed the `filterPeriod` ($t_f$), the **volatility reference** will only be a fraction of the previous **volatility accumulated**, calculated using the `reductionFactor` ($R$). If the `decayPeriod` ($t_d$) is over, the volatility resets and the **volatility reference** is zero.

This means that high frequency trades will stack up the volatility, while slowing the rate of the trades will slowly reduce the volatility, or even reset it after a long moment without any trade.

Now that the **volatility reference** is calculated, it is time to calculate the volatility introduced by the trade. To help on the calculation, the `indexRef`variable is introduced:
$$
i_r(k) = \begin{cases}
            i_r, & t < t_f \\
            activeId + k, & t_f <= t
          \end{cases}
$$

The **volatility accumulated** will then be the sum of the **volatility reference** and the **introduced volatility**, calulated using the **index reference**:
$$
v_a(k) = v_r + |i_r - (activeId + k)|
$$

The **volatility accumulated** for the bin $k$ will then be used to calculate the fees generated by swapping through this bin and be allocated to the liquidity providers of the bin.

## Protocol Fees

A share of all the fees is also taken by the protocol and distributed to JOE token holders via the StableJoeStaking contract. It is expressed as a variable, `protocolShare`, which is a percentage of the total swap fee. The maximum possible is 25%.
