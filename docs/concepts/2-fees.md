---
sidebar_position: 2
sidebar_label: Fees
---

# Fees

## Introduction

In this section we discuss fees. Fees on the Liquidity Book differ from the usual fixed rate fee from Joe V1, as here they depends on the volatility.

The swap fee is paid to liquidity providers for the trading activity that occurs. The total swap fee ($f_s$) will have two components: a **base fee** ($f_b$) and a **variable fee** ($f_v$), which is a function of instantaneous price volatility. The fee rate will be applied to the swap amount in each liquidity bin and distributed proportionally to the liquidity providers in that bin. Fees will be held separate from liquidity and claimable by liquidity providers.

## Base Fee

The base fee is similar to the Joe V1 0.3% fee. The exact percentage is set by the protocol owner using the **base factor** ($B$) and the **bin step** ($s$):

$$
f_b = B \cdot s
$$

### Variable Fee

The variable fee on the other hand depends on the volatility of the market. It will be affected by the frequency of the swaps, but doing large swaps accross many bins (on large price movements) will also increase it. Fees are calculated and distributed *per bin*, to allow a fair distribution of the fee to the liquidity providers of the bin crossed. 

*"If a swap crosses 5 bins, 5 calculations will be made. We note $k$ the index of the bin crossed, from 0 to 4."*

In the following sections, we will consider the calculation of the fees for a single bin, so everything will be a function of $k$. The total fee paid is the sum of the fees paid for every bin crossed.

The variable fee for a bin ($f_v(k)$) will be calculated using the **variable fee control** parameter ($A$), bin step ($s$) and the **volatility accumulator** ($v_a(k)$):

$$
f_v(k) = A(v_a(k) \cdot s) ^ 2
$$

### Volatility Accumulator

The **volatility accumulator** ($v_a(k)$) is the witness of the current volatility of the pair. This value will be kept in memory between each calculation step. It will be calculated during a swap and will depend on two factors: the **volatility reference** ($v_r$) from the previous swaps, and the **introduced volatility**.

At the beginning of every swap, the **volatility accumulator** of the previous swap will become the **volatility reference** for the current one. It is adjusted depending on how much time passed since the last swap, following this formula:
$$
 v_r = \begin{cases}
          v_a, & t < t_f \\
          R * v_a, & t_f <= t < t_d \\
          0 , & t_d <= t
        \end{cases}
$$
If we passed the `filterPeriod` ($t_f$), the **volatility reference** will only be a fraction of the previous **volatility accumulated**, calculated using the `reductionFactor` ($R$). If the `decayPeriod` ($t_d$) is over, the volatility resets and the **volatility reference** is zero.

This means that high frequency trades will stack up the volatility, while slowing the rate of the trades will slowly reduce the volatility, or even reset it after a long moment without any trade.

Now that the **volatility reference** is calculated, it is time to calculate the volatility introduced by the trade. To help on the calculation, the `indexRef`variable is introduced. This variable is used to evaluate the amplitude of the swap by looking at the shift of the active ID of the bin. It can be considered as the active ID of the pair at the begining of the swap *with a nuance*, as frequent trades (frequency below the filter period) won't affect it and it will be the value of the previous swap. The formula for the calculation is:
$$
i_r = \begin{cases}
        i_r, & t < t_f \\
        activeId, & t_f <= t
      \end{cases}
$$

The **volatility accumulated** will then be the sum of the **volatility reference** and the **introduced volatility**, calculated using the **index reference**:
$$
v_a(k) = v_r + |i_r - (activeId + k)|
$$

The **volatility accumulated** for the bin $k$ will then be used to calculate the fees generated by swapping through this bin and be allocated to the liquidity providers of the bin.

The final fee for the bin $k$ will be:
$f\!ee = (swap\;amount)_k * (f_b + f_v)_k$

## Protocol Fees

A share of all the fees is also taken by the protocol and distributed to JOE token holders via the StableJoeStaking contract. It is expressed as a variable, `protocolShare`, which is a percentage of the total swap fee. The maximum possible is 25%.
